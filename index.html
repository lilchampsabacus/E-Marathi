<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>E-Marathi Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        input, textarea, select { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Mic, Square, Loader2, Volume2, Smile, Frown, Zap, Hexagon, RotateCcw, Delete, Trash2 } from 'lucide-react';

        // ==========================================
        // ðŸ”‘ YOUR API KEY
        // ==========================================
        const API_KEY = 'PASTE_YOUR_AIza_KEY_HERE'; 

        const App = () => {
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [result, setResult] = useState(null);
            const [detectedSentiment, setDetectedSentiment] = useState('NEUTRAL');
            const [isLoading, setIsLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            const [activeModel, setActiveModel] = useState(null);
            
            const recognitionRef = useRef(null);
            const textAreaRef = useRef(null);

            // --- 1. AUTO-DETECT MODEL ---
            useEffect(() => {
                const checkModels = async () => {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                        const data = await response.json();
                        const validModel = data.models?.find(m => 
                            m.supportedGenerationMethods.includes("generateContent") && 
                            (m.name.includes("gemini") || m.name.includes("flash") || m.name.includes("pro"))
                        );
                        if (validModel) setActiveModel(validModel.name);
                    } catch (e) { console.error(e); }
                };
                checkModels();
            }, []);

            // --- 2. ANDROID DUPLICATION FIXER ---
            const cleanTranscript = (text) => {
                if (!text) return "";
                let cleaned = text;

                // FIX 1: Remove immediate duplicates joined together (e.g., "à¤¤à¥à¤²à¤¾à¤¤à¥à¤²à¤¾" -> "à¤¤à¥à¤²à¤¾")
                // This regex finds any group of 2+ characters that repeats immediately
                cleaned = cleaned.replace(/(.{2,})\1+/gu, '$1');

                // FIX 2: Remove duplicates separated by space (e.g., "à¤®à¥€ à¤®à¥€" -> "à¤®à¥€")
                const words = cleaned.split(' ');
                const uniqueWords = [];
                for (let i = 0; i < words.length; i++) {
                    if (i === 0 || words[i] !== words[i-1]) {
                        uniqueWords.push(words[i]);
                    }
                }
                cleaned = uniqueWords.join(' ');

                return cleaned;
            };

            // --- 3. SPEECH RECOGNITION ---
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'mr-IN'; 
                    
                    recognition.onstart = () => setIsListening(true);
                    recognition.onend = () => setIsListening(false);
                    
                    recognition.onresult = (e) => {
                        let final = '';
                        for (let i = 0; i < e.results.length; ++i) final += e.results[i][0].transcript;
                        
                        // APPLY THE FIX HERE
                        setTranscript(cleanTranscript(final)); 
                    };
                    recognitionRef.current = recognition;
                }
            }, []);

            // --- 4. EDITING TOOLS ---
            const insertText = (char) => {
                setTranscript(prev => prev + char);
                if(textAreaRef.current) textAreaRef.current.focus();
            };
            const deleteLastChar = () => setTranscript(prev => prev.slice(0, -1));
            const clearAll = () => {
                setTranscript('');
                setResult(null);
                if (isListening) recognitionRef.current?.stop();
            };

            // Stop listening if user taps to edit (prevents conflict)
            const handleFocus = () => {
                if (isListening) {
                    recognitionRef.current?.stop();
                    setIsListening(false);
                }
            };

            // --- 5. EMOTIONAL SPEECH ---
            const speakText = (text, sentiment) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                
                if (sentiment === 'HAPPY' || sentiment === 'EXCITED') {
                    utterance.pitch = 1.3; utterance.rate = 1.1; 
                } else if (sentiment === 'SAD') {
                    utterance.pitch = 0.6; utterance.rate = 0.7; 
                } else if (sentiment === 'ANGRY') {
                    utterance.pitch = 0.9; utterance.rate = 1.2; utterance.volume = 1.0;
                } else {
                    utterance.pitch = 1.0; utterance.rate = 0.9; 
                }

                const voices = window.speechSynthesis.getVoices();
                utterance.voice = voices.find(v => v.name.includes("Google US English")) || voices.find(v => v.lang === 'en-US') || voices[0];
                window.speechSynthesis.speak(utterance);
            };

            // --- 6. TRANSLATION ---
            const handleTranslate = async () => {
                if (!transcript || !activeModel) return;
                setIsLoading(true);
                setErrorMsg(null);
                
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/${activeModel}:generateContent?key=${API_KEY}`;
                    
                    const prompt = `
                    You are a backend API. 
                    Task:
                    1. Analyze this Marathi text: "${transcript}"
                    2. Detect emotion (HAPPY, SAD, ANGRY, NEUTRAL).
                    3. Translate to English.
                    4. Return ONLY a JSON object.
                    Format: { "translation": "string", "sentiment": "string" }
                    `;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                    
                    if (!jsonMatch) throw new Error("AI returned invalid data format.");

                    const parsed = JSON.parse(jsonMatch[0]);
                    setResult(parsed.translation);
                    setDetectedSentiment(parsed.sentiment);
                    speakText(parsed.translation, parsed.sentiment);
                    
                } catch (e) {
                    setErrorMsg("AI Error: " + e.message);
                }
                setIsLoading(false);
            };

            const toggleMic = () => {
                if (isListening) recognitionRef.current?.stop();
                else recognitionRef.current?.start();
            };

            const getSentimentIcon = (sent) => {
                switch(sent) {
                    case 'HAPPY': case 'EXCITED': return <Smile className="w-5 h-5 text-green-500" />;
                    case 'SAD': return <Frown className="w-5 h-5 text-blue-500" />;
                    case 'ANGRY': return <Hexagon className="w-5 h-5 text-red-500" />;
                    default: return <Volume2 className="w-5 h-5 text-gray-500" />;
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 flex flex-col items-center py-6 px-4">
                    <header className="mb-4 text-center w-full max-w-lg">
                        <h1 className="text-2xl font-bold text-gray-800">E-Marathi Translator</h1>
                        <p className="text-sm text-gray-600">Emotional Speech Translation</p>
                    </header>

                    <main className="w-full max-w-lg bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 p-5 space-y-5">
                        
                        <div className="flex justify-center">
                            <button onClick={toggleMic} className={`w-20 h-20 rounded-full flex items-center justify-center transition-all ${isListening ? 'bg-red-500 animate-pulse text-white' : 'bg-indigo-100 text-indigo-600'}`}>
                                {isListening ? <Square /> : <Mic />}
                            </button>
                        </div>

                        <div className="bg-gray-50 p-2 rounded-xl border border-gray-200">
                            <textarea 
                                ref={textAreaRef}
                                value={transcript}
                                onChange={(e) => setTranscript(e.target.value)}
                                onFocus={handleFocus} 
                                className="w-full bg-transparent p-2 outline-none resize-none text-gray-800 h-24 text-lg" 
                                placeholder="Speak or type here..."
                            ></textarea>
                            <div className="flex flex-wrap gap-2 mt-2 pt-2 border-t border-gray-200">
                                <button onClick={() => insertText('. ')} className="px-4 py-2 bg-white border rounded hover:bg-gray-100 font-bold text-lg">.</button>
                                <button onClick={() => insertText(', ')} className="px-4 py-2 bg-white border rounded hover:bg-gray-100 font-bold text-lg">,</button>
                                <button onClick={() => insertText('? ')} className="px-4 py-2 bg-white border rounded hover:bg-gray-100 font-bold text-lg">?</button>
                                <button onClick={() => insertText('! ')} className="px-4 py-2 bg-white border rounded hover:bg-gray-100 font-bold text-lg">!</button>
                                <div className="flex-1"></div>
                                <button onClick={deleteLastChar} className="p-3 text-gray-500 hover:text-red-500 bg-white border rounded"><Delete className="w-5 h-5" /></button>
                                <button onClick={clearAll} className="p-3 text-red-500 hover:bg-red-100 rounded bg-white border"><Trash2 className="w-5 h-5" /></button>
                            </div>
                        </div>

                        <button onClick={handleTranslate} disabled={!transcript || isLoading || !activeModel} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md disabled:opacity-50 text-lg">
                            {isLoading ? <><Loader2 className="inline w-5 h-5 animate-spin mr-2"/> Processing...</> : "Translate with Emotion"}
                        </button>

                        {result && (
                            <div className="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-xs font-bold text-indigo-400 uppercase">English</label>
                                    <span className="text-xs font-bold bg-white px-2 py-1 rounded border border-indigo-100 text-indigo-600 flex items-center gap-1">
                                        {getSentimentIcon(detectedSentiment)} {detectedSentiment}
                                    </span>
                                </div>
                                <p className="text-xl text-indigo-900 font-medium mb-4">{result}</p>
                                <button onClick={() => speakText(result, detectedSentiment)} className="flex items-center gap-2 px-4 py-2 bg-white text-indigo-600 rounded-lg text-sm font-bold shadow-sm border border-indigo-100 hover:bg-indigo-50 w-full justify-center">
                                    <RotateCcw className="w-4 h-4" /> Replay Emotion
                                </button>
                            </div>
                        )}
                        
                        {errorMsg && <div className="text-red-500 text-center text-sm bg-red-50 p-2 rounded border border-red-100">{errorMsg}</div>}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
</body>
</html>
